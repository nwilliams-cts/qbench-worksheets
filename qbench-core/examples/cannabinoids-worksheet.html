<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cannabinoids Worksheet - Modular QBench</title>
    
    <!-- Load the modular QBench system -->
    <link rel="stylesheet" href="../dist/qbench-worksheet.min.css">
    <script src="../dist/qbench-worksheet.min.js" defer></script>
    
    <!-- Site-specific configuration -->
    <script src="cannabinoids-config.js"></script>
</head>
<body>

<!-- QBench Worksheet Container -->
<div id="qbench-worksheet-container">
    
    <!-- JSON Data Elements (populated by QBench) -->
    <script type="application/json" id="ws-unit-config">
    {
        "allowed_units": ["ppb", "mg/g", "mg/serving", "mg/package"],
        "default_compliance": true,
        "default_uncertainty": false,
        "assay_name": "cannabinoids",
        "assay_display_name": "Cannabinoids Panel",
        "moisture_found": true,
        "moisture_value": 8.5,
        "use_moisture_correction": true
    }
    </script>

    <script type="application/json" id="ws-sample-info">
    {
        "sample_id": "SAMPLE-001",
        "sample_name": "Test Sample",
        "sample_qbn_id": "QBN-12345",
        "serving_weight": 5.0,
        "servings_per_package": 10
    }
    </script>

    <script type="application/json" id="ws-isomers-map">
    {
        "Total THC": ["THCA", "THC"],
        "Total CBD": ["CBDA", "CBD"]
    }
    </script>

    <!-- Worksheet Header -->
    <header class="worksheet-header">
        <h1>Cannabinoids Analysis Worksheet</h1>
        <div class="sample-info-bar">
            <span id="sample-display">Loading sample info...</span>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-navigation">
        <button class="ws-tab-btn active" data-ws-tab="test1">Test 1</button>
        <button class="ws-tab-btn" data-ws-tab="test2">Test 2</button>
        <button class="ws-tab-btn" data-ws-tab="test3">Test 3</button>
        <button class="ws-tab-btn" data-ws-tab="summary">Summary</button>
        <button class="ws-tab-btn" data-ws-tab="statistics">Statistics</button>
        <button class="ws-tab-btn" data-ws-tab="sample-info">Sample Info</button>
        <button class="ws-tab-btn" data-ws-tab="settings">Settings</button>
    </nav>

    <!-- Test Tabs (simplified for example) -->
    <div id="ws-tab-test1" class="tab-content">
        <h3>Test 1 - Instrument Results</h3>
        <table class="test-table">
            <thead>
                <tr>
                    <th>Include</th>
                    <th>Analyte</th>
                    <th>Raw Result</th>
                    <th>Corrected Result</th>
                    <th name="final-header">Final Result (ppb)</th>
                    <th name="limit-header">Limit</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <tr data-ws-analyte="THC" data-ws-test="1">
                    <td><input type="checkbox" class="ws-include" checked></td>
                    <td>THC</td>
                    <td><input type="number" class="ws-instrument" value="1500" step="0.1"></td>
                    <td class="ws-corrected">1500</td>
                    <td class="ws-final" name="ws_final_THC_1_ppb" data-unit="ppb">NT</td>
                    <td class="ws-limit">NT</td>
                    <td class="ws-status">NT</td>
                </tr>
                <tr data-ws-analyte="CBD" data-ws-test="1">
                    <td><input type="checkbox" class="ws-include" checked></td>
                    <td>CBD</td>
                    <td><input type="number" class="ws-instrument" value="8500" step="0.1"></td>
                    <td class="ws-corrected">8500</td>
                    <td class="ws-final" name="ws_final_CBD_1_ppb" data-unit="ppb">NT</td>
                    <td class="ws-limit">NT</td>
                    <td class="ws-status">NT</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Summary Tab -->
    <div id="ws-tab-summary" class="tab-content" style="display: none;">
        <h3>Summary Results</h3>
        
        <!-- Multi-unit selector -->
        <div class="unit-selector-container">
            <h4>Output Units:</h4>
            <div id="multi-unit-checkboxes">
                <!-- Populated by JavaScript -->
            </div>
            
            <h4>Display Unit:</h4>
            <select id="display-unit-selector">
                <!-- Populated by JavaScript -->
            </select>
        </div>

        <table class="summary-table">
            <thead>
                <tr>
                    <th>Include</th>
                    <th>Analyte</th>
                    <th>N</th>
                    <th name="final-header">Mean Result (ppb)</th>
                    <th name="limit-header">Limit</th>
                    <th>Status</th>
                    <th>RSD %</th>
                </tr>
            </thead>
            <tbody id="ws-summary-body">
                <tr data-ws-analyte="THC">
                    <td><input type="checkbox" class="ws-include" checked></td>
                    <td>THC</td>
                    <td class="ws-count">3</td>
                    <td class="ws-summary-mean" name="ws_mean_THC_ppb" data-unit="ppb">NT</td>
                    <td class="ws-summary-limit">NT</td>
                    <td class="ws-summary-status">NT</td>
                    <td class="ws-rsd">NT</td>
                </tr>
                <tr data-ws-analyte="CBD">
                    <td><input type="checkbox" class="ws-include" checked></td>
                    <td>CBD</td>
                    <td class="ws-count">3</td>
                    <td class="ws-summary-mean" name="ws_mean_CBD_ppb" data-unit="ppb">NT</td>
                    <td class="ws-summary-limit">NT</td>
                    <td class="ws-summary-status">NT</td>
                    <td class="ws-rsd">NT</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Settings Tab -->
    <div id="ws-tab-settings" class="tab-content" style="display: none;">
        <h3>Worksheet Settings</h3>
        
        <div class="settings-grid">
            <!-- Calculation Settings -->
            <div class="settings-section">
                <h4>Calculation Settings</h4>
                <label>
                    Significant Figures:
                    <input type="number" id="sig-fig-input" min="1" max="10" value="3">
                </label>
                
                <label>
                    <input type="checkbox" id="compliance-checkbox" checked>
                    Enable Compliance Mode
                </label>
                
                <label>
                    <input type="checkbox" id="uncertainty-checkbox">
                    Apply Uncertainty Calculations
                </label>
            </div>

            <!-- Data Integrity -->
            <div class="settings-section">
                <h4>Data Integrity Protection</h4>
                <div id="protection-status" class="protection-status locked">LOCKED</div>
                
                <button id="unlock-data-btn">Request Data Unlock</button>
                <button id="lock-data-btn" disabled>Lock Data</button>
                
                <div id="deviation-summary">
                    <span style="color: #28a745;">âœ… No deviations logged.</span><br>
                    <small>All instrument data remains unmodified.</small>
                </div>
                
                <button id="review-deviations-btn">Review Deviations</button>
            </div>

            <!-- Results Generation -->
            <div class="settings-section">
                <h4>Results</h4>
                <button id="generate-final-results-btn">Generate Final Results</button>
                <button id="view-final-results-btn">View Final Results JSON</button>
            </div>
        </div>
    </div>

    <!-- Data Integrity Modal -->
    <div id="deviation-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="deviation-close">&times;</span>
            <h3>ðŸ”’ Data Integrity Deviation Request</h3>
            
            <form id="deviation-form">
                <label for="analyst-name">Analyst Name:</label>
                <input type="text" id="analyst-name" required>
                
                <label for="deviation-reason">Reason for Data Modification:</label>
                <select id="deviation-reason" required>
                    <option value="">Select reason...</option>
                    <option value="Instrument Error">Instrument Error</option>
                    <option value="Calculation Error">Calculation Error</option>
                    <option value="Sample Contamination">Sample Contamination</option>
                    <option value="Other">Other</option>
                </select>
                
                <label for="deviation-description">Detailed Description:</label>
                <textarea id="deviation-description" placeholder="Provide detailed explanation..." required></textarea>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" id="cancel-deviation">Cancel</button>
                    <button type="submit">Log Deviation & Unlock</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hidden fields for data storage -->
    <input type="hidden" name="ws_instrument_results" value="{}">
    <input type="hidden" name="ws_live_results" value="{}">
    <input type="hidden" name="ws_final_results" value="">
    <input type="hidden" name="ws_deviations" value="">

</div>

<!-- Initialize the worksheet -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize QBench Worksheet with site-specific configuration
    if (window.QBenchWorksheet && window.QBENCH_CONFIG) {
        console.log('Initializing QBench Worksheet with configuration:', window.QBENCH_CONFIG);
        window.QBenchWorksheet.init(window.QBENCH_CONFIG);
    } else {
        console.error('QBench Worksheet or configuration not found');
    }
});
</script>

</body>
</html>
