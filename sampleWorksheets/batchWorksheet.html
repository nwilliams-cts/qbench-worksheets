{% set ns = namespace() %}
{# Batch Worksheet - Generic Template #}
{% set ns.worksheet_assay_id = batch.assay.id %}

<style>
/* Smithers Corporate Color Scheme - Scoped to Batch Worksheet */
.qbench-batch-worksheet-container {
  --smithers-navy-dark: #0a2240;
  --smithers-navy: #003a70;
  --smithers-blue: #236092;
  --smithers-yellow: #f6cd3e;
  --smithers-yellow-light: #fedb54;
  --smithers-gray-dark: #48484a;
  --smithers-gray: #cdcfd0;
  --smithers-gray-light: #e7eaec;
  --success-green: #27ae60;
  --warning-yellow: #f39c12;
  --danger-red: #e74c3c;
}

/* Container Styling */
.qbench-batch-worksheet-container {
  font-family: Arial, sans-serif;
  max-width: 1600px;
  margin: 20px auto;
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Header Styles */
.qbench-batch-worksheet-container .qbws-batch-header {
  border-bottom: 3px solid var(--smithers-navy);
  padding-bottom: 15px;
  margin-bottom: 20px;
}

.qbench-batch-worksheet-container .qbws-batch-header h1 {
  margin: 0;
  color: var(--smithers-navy-dark);
  font-size: 24px;
  font-weight: 700;
}

.qbench-batch-worksheet-container .qbws-batch-header .qbws-batch-meta {
  color: #666;
  font-size: 14px;
  margin-top: 8px;
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}

.qbench-batch-worksheet-container .qbws-batch-header .qbws-batch-meta span {
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

.qbench-batch-worksheet-container .qbws-batch-header .qbws-batch-meta strong {
  color: var(--smithers-navy);
}

/* Tab Navigation */
.qbench-batch-worksheet-container .qbws-tab-navigation {
  display: flex;
  gap: 5px;
  border-bottom: 2px solid var(--smithers-gray);
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.qbench-batch-worksheet-container .qbws-tab-button {
  padding: 12px 24px;
  background: var(--smithers-gray-light);
  border: none;
  border-bottom: 3px solid transparent;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.3s ease;
  color: var(--smithers-navy-dark);
  border-radius: 6px 6px 0 0;
}

.qbench-batch-worksheet-container .qbws-tab-button:hover {
  background: var(--smithers-gray);
  transform: translateY(-1px);
}

.qbench-batch-worksheet-container .qbws-tab-button.active {
  background: var(--smithers-navy);
  color: white;
  border-bottom-color: var(--smithers-navy-dark);
  font-weight: 700;
}

/* Tab Content */
.qbench-batch-worksheet-container .qbws-tab-content {
  display: none;
  animation: qbwsFadeIn 0.3s ease;
}

.qbench-batch-worksheet-container .qbws-tab-content.active {
  display: block;
}

@keyframes qbwsFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Info Grid (Read-only batch info) */
.qbench-batch-worksheet-container .qbws-info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 15px;
  margin-bottom: 25px;
  padding: 20px;
  background: var(--smithers-gray-light);
  border-radius: 6px;
  border-left: 4px solid var(--smithers-navy);
}

.qbench-batch-worksheet-container .qbws-info-item {
  display: flex;
  flex-direction: column;
}

.qbench-batch-worksheet-container .qbws-info-item label {
  font-weight: 600;
  font-size: 11px;
  color: var(--smithers-gray-dark);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 5px;
}

.qbench-batch-worksheet-container .qbws-info-item span {
  font-size: 16px;
  color: var(--smithers-navy-dark);
  font-weight: 500;
}

/* Form Section */
.qbench-batch-worksheet-container .qbws-form-section {
  margin-bottom: 30px;
  padding: 20px;
  background: #fafafa;
  border-radius: 6px;
  border: 1px solid var(--smithers-gray);
}

.qbench-batch-worksheet-container .qbws-form-section h3 {
  margin-top: 0;
  color: var(--smithers-navy-dark);
  font-size: 18px;
  border-bottom: 2px solid var(--smithers-navy);
  padding-bottom: 10px;
  margin-bottom: 20px;
}

.qbench-batch-worksheet-container .qbws-form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 15px;
}

.qbench-batch-worksheet-container .qbws-form-field {
  display: flex;
  flex-direction: column;
}

.qbench-batch-worksheet-container .qbws-form-field label {
  font-weight: 600;
  margin-bottom: 6px;
  color: var(--smithers-gray-dark);
  font-size: 13px;
}

.qbench-batch-worksheet-container .qbws-form-field.required label::after {
  content: " *";
  color: var(--danger-red);
  font-weight: 700;
}

.qbench-batch-worksheet-container .qbws-form-field input,
.qbench-batch-worksheet-container .qbws-form-field select,
.qbench-batch-worksheet-container .qbws-form-field textarea {
  padding: 10px 12px;
  border: 1px solid var(--smithers-gray);
  border-radius: 4px;
  font-size: 14px;
  transition: all 0.3s ease;
  font-family: Arial, sans-serif;
}

.qbench-batch-worksheet-container .qbws-form-field input:focus,
.qbench-batch-worksheet-container .qbws-form-field select:focus,
.qbench-batch-worksheet-container .qbws-form-field textarea:focus {
  outline: none;
  border-color: var(--smithers-blue);
  box-shadow: 0 0 0 3px rgba(35, 96, 146, 0.1);
}

.qbench-batch-worksheet-container .qbws-form-field input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

/* QC Table Styles */
.qbench-batch-worksheet-container .qbws-qc-table-container {
  overflow-x: auto;
  margin-bottom: 25px;
}

.qbench-batch-worksheet-container .qbws-qc-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  background: white;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.qbench-batch-worksheet-container .qbws-qc-table thead {
  background: var(--smithers-navy-dark);
  color: white;
  position: sticky;
  top: 0;
  z-index: 10;
}

.qbench-batch-worksheet-container .qbws-qc-table th {
  padding: 12px 10px;
  text-align: center;
  font-weight: 600;
  border: 1px solid rgba(255,255,255,0.2);
  white-space: nowrap;
}

.qbench-batch-worksheet-container .qbws-qc-table td {
  padding: 10px;
  text-align: center;
  border: 1px solid var(--smithers-gray);
}

.qbench-batch-worksheet-container .qbws-qc-table tbody tr:hover {
  background: var(--smithers-gray-light);
}

.qbench-batch-worksheet-container .qbws-qc-table .qbws-qc-type-cell {
  font-weight: 600;
  text-align: left;
  color: var(--smithers-navy);
}

/* Status Indicators */
.qbench-batch-worksheet-container .qbws-status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}

.qbench-batch-worksheet-container .qbws-status-pass {
  background: var(--success-green);
  color: white;
}

.qbench-batch-worksheet-container .qbws-status-pass::before {
  content: "✓ ";
}

.qbench-batch-worksheet-container .qbws-status-fail {
  background: var(--danger-red);
  color: white;
}

.qbench-batch-worksheet-container .qbws-status-fail::before {
  content: "✗ ";
}

.qbench-batch-worksheet-container .qbws-status-warning {
  background: var(--warning-yellow);
  color: white;
}

.qbench-batch-worksheet-container .qbws-status-warning::before {
  content: "⚠ ";
}

.qbench-batch-worksheet-container .qbws-status-na {
  background: var(--smithers-gray);
  color: var(--smithers-gray-dark);
}

/* Run Sequence Styles */
.qbench-batch-worksheet-container .qbws-run-sequence {
  background: white;
  border: 1px solid var(--smithers-gray);
  border-radius: 6px;
  padding: 20px;
  margin-bottom: 20px;
}

.qbench-batch-worksheet-container .qbws-run-sequence h4 {
  margin-top: 0;
  color: var(--smithers-navy-dark);
  border-bottom: 2px solid var(--smithers-gray);
  padding-bottom: 8px;
}

.qbench-batch-worksheet-container .qbws-sequence-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.qbench-batch-worksheet-container .qbws-sequence-item {
  padding: 8px 12px;
  margin: 4px 0;
  background: var(--smithers-gray-light);
  border-radius: 4px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background 0.3s ease;
}

.qbench-batch-worksheet-container .qbws-sequence-item:hover {
  background: var(--smithers-gray);
}

.qbench-batch-worksheet-container .qbws-sequence-item.flagged {
  background: #fff3cd;
  border-left: 4px solid var(--warning-yellow);
}

.qbench-batch-worksheet-container .qbws-sequence-item.qc-fail {
  background: #f8d7da;
  border-left: 4px solid var(--danger-red);
}

/* Checklist Table */
.qbench-batch-worksheet-container .qbws-checklist-table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.qbench-batch-worksheet-container .qbws-checklist-table thead {
  background: var(--smithers-navy);
  color: white;
}

.qbench-batch-worksheet-container .qbws-checklist-table th {
  padding: 12px;
  text-align: left;
  font-weight: 600;
}

.qbench-batch-worksheet-container .qbws-checklist-table td {
  padding: 12px;
  border: 1px solid var(--smithers-gray);
  vertical-align: top;
}

.qbench-batch-worksheet-container .qbws-checklist-table tr:hover {
  background: var(--smithers-gray-light);
}

.qbench-batch-worksheet-container .qbws-checklist-table input[type="checkbox"] {
  width: 24px;
  height: 24px;
  cursor: pointer;
}

.qbench-batch-worksheet-container .qbws-checklist-table input[type="text"],
.qbench-batch-worksheet-container .qbws-checklist-table textarea {
  width: 100%;
  padding: 6px 10px;
  border: 1px solid var(--smithers-gray);
  border-radius: 4px;
  font-size: 13px;
}

.qbench-batch-worksheet-container .qbws-checklist-table textarea {
  min-height: 60px;
  resize: vertical;
  font-family: Arial, sans-serif;
}

/* Approval Section */
.qbench-batch-worksheet-container .qbws-approval-section {
  padding: 30px;
  background: var(--smithers-gray-light);
  border-radius: 6px;
  margin-bottom: 20px;
}

.qbench-batch-worksheet-container .qbws-approval-checks {
  background: white;
  padding: 20px;
  border-radius: 6px;
  margin-bottom: 20px;
  border: 1px solid var(--smithers-gray);
}

.qbench-batch-worksheet-container .qbws-approval-checks h4 {
  margin-top: 0;
  color: var(--smithers-navy-dark);
}

.qbench-batch-worksheet-container .qbws-approval-check-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  margin: 8px 0;
  background: var(--smithers-gray-light);
  border-radius: 4px;
}

.qbench-batch-worksheet-container .qbws-approval-check-item.pass {
  background: #d4edda;
}

.qbench-batch-worksheet-container .qbws-approval-check-item.fail {
  background: #f8d7da;
}

.qbench-batch-worksheet-container .qbws-approval-actions {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}

.qbench-batch-worksheet-container .qbws-btn {
  padding: 14px 28px;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.qbench-batch-worksheet-container .qbws-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.qbench-batch-worksheet-container .qbws-btn:active {
  transform: translateY(0);
}

.qbench-batch-worksheet-container .qbws-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.qbench-batch-worksheet-container .qbws-btn-approve {
  background: var(--success-green);
  color: white;
}

.qbench-batch-worksheet-container .qbws-btn-approve:hover:not(:disabled) {
  background: #229954;
}

.qbench-batch-worksheet-container .qbws-btn-reject {
  background: var(--danger-red);
  color: white;
}

.qbench-batch-worksheet-container .qbws-btn-reject:hover:not(:disabled) {
  background: #c0392b;
}

.qbench-batch-worksheet-container .qbws-btn-partial {
  background: var(--warning-yellow);
  color: white;
}

.qbench-batch-worksheet-container .qbws-btn-partial:hover:not(:disabled) {
  background: #d68910;
}

.qbench-batch-worksheet-container .qbws-btn-save {
  background: var(--smithers-blue);
  color: white;
}

.qbench-batch-worksheet-container .qbws-btn-save:hover {
  background: var(--smithers-navy);
}

.qbench-batch-worksheet-container .qbws-btn-export {
  background: var(--smithers-navy-dark);
  color: white;
}

.qbench-batch-worksheet-container .qbws-btn-export:hover {
  background: #051528;
}

/* Alert Messages */
.qbench-batch-worksheet-container .qbws-alert {
  padding: 15px 20px;
  border-radius: 6px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.qbench-batch-worksheet-container .qbws-alert-info {
  background: #d1ecf1;
  border-left: 4px solid #0c5460;
  color: #0c5460;
}

.qbench-batch-worksheet-container .qbws-alert-warning {
  background: #fff3cd;
  border-left: 4px solid var(--warning-yellow);
  color: #856404;
}

.qbench-batch-worksheet-container .qbws-alert-danger {
  background: #f8d7da;
  border-left: 4px solid var(--danger-red);
  color: #721c24;
}

.qbench-batch-worksheet-container .qbws-alert-success {
  background: #d4edda;
  border-left: 4px solid var(--success-green);
  color: #155724;
}

/* Expandable Details */
.qbench-batch-worksheet-container .qbws-expandable {
  cursor: pointer;
  user-select: none;
}

.qbench-batch-worksheet-container .qbws-expandable::before {
  content: "▶ ";
  display: inline-block;
  transition: transform 0.3s ease;
}

.qbench-batch-worksheet-container .qbws-expandable.expanded::before {
  transform: rotate(90deg);
}

.qbench-batch-worksheet-container .qbws-expandable-content {
  display: none;
  padding: 15px;
  background: white;
  border: 1px solid var(--smithers-gray);
  border-radius: 4px;
  margin-top: 10px;
}

.qbench-batch-worksheet-container .qbws-expandable-content.show {
  display: block;
}

/* Loading Spinner */
.qbench-batch-worksheet-container .qbws-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(0,0,0,0.1);
  border-top-color: var(--smithers-blue);
  border-radius: 50%;
  animation: qbwsSpin 0.8s linear infinite;
}

@keyframes qbwsSpin {
  to { transform: rotate(360deg); }
}

/* Tooltips */
.qbench-batch-worksheet-container [data-qbws-tooltip] {
  position: relative;
  cursor: help;
  border-bottom: 1px dotted var(--smithers-gray-dark);
}

.qbench-batch-worksheet-container [data-qbws-tooltip]::after {
  content: attr(data-qbws-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  padding: 6px 10px;
  background: var(--smithers-navy-dark);
  color: white;
  font-size: 12px;
  white-space: nowrap;
  border-radius: 4px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  z-index: 100;
}

.qbench-batch-worksheet-container [data-qbws-tooltip]:hover::after {
  opacity: 1;
}

/* Responsive Design */
@media (max-width: 768px) {
  .qbench-batch-worksheet-container {
    margin: 10px;
    padding: 15px;
  }
  
  .qbench-batch-worksheet-container .qbws-tab-navigation {
    flex-direction: column;
  }
  
  .qbench-batch-worksheet-container .qbws-form-row {
    grid-template-columns: 1fr;
  }
  
  .qbench-batch-worksheet-container .qbws-info-grid {
    grid-template-columns: 1fr;
  }
  
  .qbench-batch-worksheet-container .qbws-approval-actions {
    flex-direction: column;
  }
  
  .qbench-batch-worksheet-container .qbws-btn {
    width: 100%;
  }
}

/* Print Styles */
@media print {
  .qbench-batch-worksheet-container .qbws-tab-navigation,
  .qbench-batch-worksheet-container .qbws-btn,
  .qbench-batch-worksheet-container .qbws-form-field input,
  .qbench-batch-worksheet-container .qbws-form-field select {
    display: none;
  }
  
  .qbench-batch-worksheet-container .qbws-tab-content {
    display: block !important;
  }
  
  .qbench-batch-worksheet-container {
    box-shadow: none;
  }
}
</style>

<!-- Batch Worksheet Container -->
<div class="qbench-batch-worksheet-container">

    <!-- Hidden Data Fields for LIMS Save -->
    <div style="display:none;">__(textarea, ws_batch_metadata, default_value="{}")__</div>
    <div style="display:none;">__(textarea, ws_batch_qc_results, default_value="{}")__</div>
    <div style="display:none;">__(textarea, ws_batch_checklist, default_value="{}")__</div>
    <div style="display:none;">__(textarea, ws_batch_approval, default_value="{}")__</div>

    <!-- Batch Header -->
    <div class="qbws-batch-header">
        <h1>Batch Worksheet - {{ batch.id }}</h1>
        <div class="qbws-batch-meta">
            <span><strong>Assay:</strong> {{ batch.assay.title }}</span>
            <span><strong>Created:</strong> {{ batch.created_at.strftime('%Y-%m-%d %H:%M') if batch.created_at else 'N/A' }}</span>
            <span><strong>Status:</strong> {{ batch.status }}</span>
            <span><strong>Samples:</strong> {{ batch.samples|length }}</span>
            <span><strong>Tests:</strong> <span id="qbws-total-tests-count">{{ batch.tests|length }}</span></span>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="qbws-tab-navigation">
        <button class="qbws-tab-button active" onclick="qbwsSwitchTab('batch-info')">Batch Info</button>
        <button class="qbws-tab-button" onclick="qbwsSwitchTab('qc-review')">QC Review</button>
        <button class="qbws-tab-button" onclick="qbwsSwitchTab('checklist')">Protocol Checklist</button>
        <button class="qbws-tab-button" onclick="qbwsSwitchTab('approval')">Approve/Reject</button>
    </div>

    <!-- Tab 1: Batch Info -->
    <div id="qbws-batch-info" class="qbws-tab-content active">
        <h2 style="color: var(--smithers-navy-dark); margin-top: 0;">Batch Information & Metadata</h2>
        
        <!-- Read-only Batch Info -->
        <div class="qbws-info-grid">
            <div class="qbws-info-item">
                <label>Batch ID</label>
                <span>{{ batch.id }}</span>
            </div>
            <div class="qbws-info-item">
                <label>Assay Name</label>
                <span>{{ batch.assay.title }}</span>
            </div>
            <div class="qbws-info-item">
                <label>Assay ID</label>
                <span>{{ batch.assay.id }}</span>
            </div>
            <div class="qbws-info-item">
                <label>Date Created</label>
                <span>{{ batch.created_at.strftime('%Y-%m-%d') if batch.created_at else 'N/A' }}</span>
            </div>
            <div class="qbws-info-item">
                <label>Current Status</label>
                <span>{{ batch.status }}</span>
            </div>
            <div class="qbws-info-item">
                <label>Total Samples</label>
                <span>{{ batch.samples|length }}</span>
            </div>
            <div class="qbws-info-item">
                <label>Total Tests</label>
                <span>{{ batch.tests|length }}</span>
            </div>
        </div>

        <!-- Instrument Information -->
        <div class="qbws-form-section">
            <h3>Instrument Information</h3>
            <div class="qbws-form-row">
                <div class="qbws-form-field required">
                    <label for="instrument-id">Instrument ID</label>
                    <input type="text" id="instrument-id" name="instrument_id" placeholder="e.g., HPLC-001" onchange="saveBatchMetadata()">
                </div>
                <div class="qbws-form-field required">
                    <label for="column-id">Column ID/Lot</label>
                    <input type="text" id="column-id" name="column_id" placeholder="e.g., COL-12345" onchange="saveBatchMetadata()">
                </div>
                <div class="qbws-form-field">
                    <label for="column-pressure">Column Pressure (bar)</label>
                    <input type="number" step="0.1" id="column-pressure" name="column_pressure_bar" placeholder="e.g., 350.5" onchange="saveBatchMetadata()">
                </div>
            </div>
        </div>

        <!-- Mobile Phase Information -->
        <div class="qbws-form-section">
            <h3>Mobile Phase Information</h3>
            <div class="qbws-form-row">
                <div class="qbws-form-field required">
                    <label for="mobile-phase-lot">Mobile Phase Lot</label>
                    <input type="text" id="mobile-phase-lot" name="mobile_phase_lot" placeholder="e.g., MP-2024-001" onchange="saveBatchMetadata()">
                </div>
                <div class="qbws-form-field required">
                    <label for="mobile-phase-prep-date">Prep Date</label>
                    <input type="date" id="mobile-phase-prep-date" name="mobile_phase_prep_date" onchange="saveBatchMetadata()">
                </div>
                <div class="qbws-form-field required">
                    <label for="mobile-phase-prep-analyst">Prepared By</label>
                    <input type="text" id="mobile-phase-prep-analyst" name="mobile_phase_prep_analyst" placeholder="Analyst name" onchange="saveBatchMetadata()">
                </div>
            </div>
        </div>

        <!-- Run Information -->
        <div class="qbws-form-section">
            <h3>Run Information</h3>
            <div class="qbws-form-row">
                <div class="qbws-form-field required">
                    <label for="run-start-time">Run Start Time</label>
                    <input type="datetime-local" id="run-start-time" name="run_start_time" onchange="saveBatchMetadata()">
                </div>
                <div class="qbws-form-field">
                    <label for="run-end-time">Run End Time</label>
                    <input type="datetime-local" id="run-end-time" name="run_end_time" onchange="saveBatchMetadata()">
                </div>
                <div class="qbws-form-field required">
                    <label for="data-reviewed-by">Data Reviewed By</label>
                    <input type="text" id="data-reviewed-by" name="data_reviewed_by" placeholder="Analyst name" onchange="saveBatchMetadata()">
                </div>
            </div>
        </div>

        <!-- Environmental Conditions -->
        <div class="qbws-form-section">
            <h3>Environmental Conditions (Optional)</h3>
            <div class="qbws-form-row">
                <div class="qbws-form-field">
                    <label for="lab-temperature">Lab Temperature (°C)</label>
                    <input type="number" step="0.1" id="lab-temperature" name="lab_temperature" placeholder="e.g., 22.5" onchange="saveBatchMetadata()">
                </div>
                <div class="qbws-form-field">
                    <label for="lab-humidity">Lab Humidity (%)</label>
                    <input type="number" step="0.1" id="lab-humidity" name="lab_humidity" placeholder="e.g., 45.0" onchange="saveBatchMetadata()">
                </div>
            </div>
        </div>

        <!-- Additional Notes -->
        <div class="qbws-form-section">
            <h3>Additional Notes</h3>
            <div class="qbws-form-row">
                <div class="qbws-form-field" style="grid-column: 1 / -1;">
                    <label for="batch-notes">Batch Notes</label>
                    <textarea id="batch-notes" name="batch_notes" rows="4" placeholder="Enter any additional notes about this batch..." onchange="saveBatchMetadata()"></textarea>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button class="qbws-btn qbws-btn-save" onclick="saveBatchMetadata()">Save Metadata</button>
            <button class="qbws-btn qbws-btn-export" onclick="exportAuditLog()">Export Audit Log</button>
        </div>
    </div>

    <!-- Tab 2: QC Review -->
    <div id="qbws-qc-review" class="qbws-tab-content">
        <h2 style="color: var(--smithers-navy-dark); margin-top: 0;">QC Data Review</h2>
        
        <div class="qbws-alert qbws-alert-info">
            <strong>ℹ Info:</strong> QC data is loaded from the batch worksheet control_data after file upload. Review all QC samples below and ensure they meet acceptance criteria.
        </div>

        <!-- QC Summary Table -->
        <div class="qbws-qc-table-container">
            <table class="qbws-qc-table" id="qc-summary-table">
                <thead>
                    <tr>
                        <th>QC Type</th>
                        <th>QC ID</th>
                        <th>Sample/Test ID</th>
                        <th id="qc-table-analytes-header">Analytes</th>
                        <th>Overall Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="qc-table-body">
                    <!-- Populated by JavaScript -->
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                            No QC data loaded. Upload data file to populate QC results.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Run Sequence -->
        <div class="qbws-run-sequence">
            <h4 class="qbws-expandable" onclick="qbwsToggleExpandable(this)">Sample Run Sequence</h4>
            <div class="qbws-expandable-content">
                <ol class="qbws-sequence-list" id="run-sequence-list">
                    <!-- Populated by JavaScript -->
                    <li style="text-align: center; color: #999; padding: 20px;">No sequence data available</li>
                </ol>
            </div>
        </div>

        <!-- Batch QC Criteria -->
        <div class="qbws-run-sequence">
            <h4 class="qbws-expandable" onclick="qbwsToggleExpandable(this)">Batch-Level QC Criteria</h4>
            <div class="qbws-expandable-content">
                <div id="batch-qc-criteria">
                    <!-- Populated by JavaScript -->
                    <p style="color: #999;">Criteria will be loaded from KVStore configuration</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 3: Protocol Checklist -->
    <div id="qbws-checklist" class="qbws-tab-content">
        <h2 style="color: var(--smithers-navy-dark); margin-top: 0;">Protocol Checklist</h2>
        
        <div class="qbws-alert qbws-alert-warning">
            <strong>⚠ Warning:</strong> Complete all required checklist items before proceeding. Some actions are gated by checklist completion.
        </div>

        <table class="qbws-checklist-table">
            <thead>
                <tr>
                    <th style="width: 50px;">✓</th>
                    <th>Step Description</th>
                    <th style="width: 200px;">Required Before</th>
                    <th style="width: 300px;">Notes/Deviations</th>
                </tr>
            </thead>
            <tbody>
                <!-- Sample Prep Section -->
                <tr>
                    <td><input type="checkbox" id="check-reagents" onchange="saveChecklist()"></td>
                    <td><strong>All extraction reagent lots added to batch</strong></td>
                    <td>Generating instrument sequence</td>
                    <td><textarea id="notes-reagents" placeholder="Enter any notes or deviations..." onchange="saveChecklist()"></textarea></td>
                </tr>
                <tr>
                    <td><input type="checkbox" id="check-mobile-phase" onchange="saveChecklist()"></td>
                    <td><strong>Mobile phase prepared and logged</strong></td>
                    <td>Generating instrument sequence</td>
                    <td><textarea id="notes-mobile-phase" placeholder="Enter any notes or deviations..." onchange="saveChecklist()"></textarea></td>
                </tr>
                <tr>
                    <td><input type="checkbox" id="check-standards" onchange="saveChecklist()"></td>
                    <td><strong>Calibration standards prepared</strong></td>
                    <td>Generating instrument sequence</td>
                    <td><textarea id="notes-standards" placeholder="Enter any notes or deviations..." onchange="saveChecklist()"></textarea></td>
                </tr>
                <tr>
                    <td><input type="checkbox" id="check-qc-samples" onchange="saveChecklist()"></td>
                    <td><strong>QC samples prepared (CCV, MB, LCS, etc.)</strong></td>
                    <td>Generating instrument sequence</td>
                    <td><textarea id="notes-qc-samples" placeholder="Enter any notes or deviations..." onchange="saveChecklist()"></textarea></td>
                </tr>
                
                <!-- Instrument Section -->
                <tr style="background: var(--smithers-gray-light);">
                    <td colspan="4"><strong style="color: var(--smithers-navy-dark);">INSTRUMENT SETUP</strong></td>
                </tr>
                <tr>
                    <td><input type="checkbox" id="check-column" onchange="saveChecklist()"></td>
                    <td><strong>HPLC column installed and conditioned</strong></td>
                    <td>Running sequence</td>
                    <td><textarea id="notes-column" placeholder="Enter any notes or deviations..." onchange="saveChecklist()"></textarea></td>
                </tr>
                <tr>
                    <td><input type="checkbox" id="check-calibration" onchange="saveChecklist()"></td>
                    <td><strong>Instrument calibration verified</strong></td>
                    <td>Running sequence</td>
                    <td><textarea id="notes-calibration" placeholder="Enter any notes or deviations..." onchange="saveChecklist()"></textarea></td>
                </tr>
                <tr>
                    <td><input type="checkbox" id="check-system-suitability" onchange="saveChecklist()"></td>
                    <td><strong>System suitability test passed</strong></td>
                    <td>Running sequence</td>
                    <td><textarea id="notes-system-suitability" placeholder="Enter any notes or deviations..." onchange="saveChecklist()"></textarea></td>
                </tr>
                
                <!-- Data Review Section -->
                <tr style="background: var(--smithers-gray-light);">
                    <td colspan="4"><strong style="color: var(--smithers-navy-dark);">DATA REVIEW</strong></td>
                </tr>
                <tr>
                    <td><input type="checkbox" id="check-data-uploaded" onchange="saveChecklist()"></td>
                    <td><strong>Data file uploaded to batch</strong></td>
                    <td>Reviewing QC</td>
                    <td><textarea id="notes-data-upload" placeholder="Enter any notes or deviations..." onchange="saveChecklist()"></textarea></td>
                </tr>
                <tr>
                    <td><input type="checkbox" id="check-qc-reviewed" onchange="saveChecklist()"></td>
                    <td><strong>All QC samples reviewed and passing</strong></td>
                    <td>Approving batch</td>
                    <td><textarea id="notes-qc-review" placeholder="Enter any notes or deviations..." onchange="saveChecklist()"></textarea></td>
                </tr>
                <tr>
                    <td><input type="checkbox" id="check-samples-reviewed" onchange="saveChecklist()"></td>
                    <td><strong>Sample worksheets calculated and reviewed</strong></td>
                    <td>Approving batch</td>
                    <td><textarea id="notes-sample-review" placeholder="Enter any notes or deviations..." onchange="saveChecklist()"></textarea></td>
                </tr>
                <tr>
                    <td><input type="checkbox" id="check-deviations-documented" onchange="saveChecklist()"></td>
                    <td><strong>All deviations documented</strong></td>
                    <td>Approving batch</td>
                    <td><textarea id="notes-deviations" placeholder="Enter any notes or deviations..." onchange="saveChecklist()"></textarea></td>
                </tr>
            </tbody>
        </table>

        <div style="margin-top: 20px;">
            <button class="qbws-btn qbws-btn-save" onclick="saveChecklist()">Save Checklist</button>
        </div>
    </div>

    <!-- Tab 4: Approve/Reject -->
    <div id="qbws-approval" class="qbws-tab-content">
        <h2 style="color: var(--smithers-navy-dark); margin-top: 0;">Batch Approval</h2>
        
        <!-- Pre-Approval Checks -->
        <div class="qbws-approval-checks">
            <h4>Pre-Approval Validation</h4>
            <div id="approval-checks-list">
                <!-- Populated by JavaScript -->
                <div class="qbws-approval-check-item">
                    <span class="qbws-spinner"></span>
                    <span>Checking batch status...</span>
                </div>
            </div>
        </div>

        <!-- Approval Actions -->
        <div class="qbws-approval-section">
            <h3 style="margin-top: 0;">Approval Actions</h3>
            
            <div class="qbws-approval-actions">
                <button class="qbws-btn qbws-btn-approve" id="approve-btn" onclick="approveBatch()" disabled>
                    ✅ Approve Batch
                </button>
                <button class="qbws-btn qbws-btn-reject" id="reject-btn" onclick="rejectBatch()">
                    ❌ Reject Batch
                </button>
                <button class="qbws-btn qbws-btn-partial" id="partial-btn" onclick="partialApproval()">
                    ⚠️ Partial Approval (Flag for Retest)
                </button>
            </div>

            <div style="margin-top: 25px; padding: 20px; background: white; border-radius: 6px; border: 1px solid var(--smithers-gray);">
                <h4 style="margin-top: 0;">Approval Comments</h4>
                <textarea id="approval-comments" rows="4" style="width: 100%; padding: 10px; border: 1px solid var(--smithers-gray); border-radius: 4px; font-family: Arial, sans-serif;" placeholder="Enter approval comments or reason for rejection..."></textarea>
            </div>
        </div>

        <!-- Approval History -->
        <div class="qbws-run-sequence">
            <h4 class="qbws-expandable" onclick="qbwsToggleExpandable(this)">Approval History</h4>
            <div class="qbws-expandable-content">
                <div id="approval-history">
                    <p style="color: #999;">No approval history available</p>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- JavaScript -->
<script type="application/json" id="batch-config">
{
    "batch_id": "{{ batch.id }}",
    "assay_id": {{ batch.assay.id }},
    "assay_title": "{{ batch.assay.title }}",
    "assay_params": {{ batch.assay.assay_params }},
    "total_samples": {{ batch.samples|length }},
    "total_tests": {{ batch.tests|length }},
    "created_at": "{{ batch.created_at.isoformat() if batch.created_at else '' }}"
}
</script>

<script>
// Global state
let batchConfig = {};
let kvstoreData = {};
let controlData = {};
let testingFileOrder = [];
let batchMetadata = {};
let checklistData = {};
let qcResults = {};
let approvalData = {};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Batch Worksheet Initializing...');
    
    // Load batch config
    batchConfig = JSON.parse(document.getElementById('batch-config').textContent);
    console.log('Batch Config:', batchConfig);
    
    // Load saved data from QBench fields
    loadSavedData();
    
    // Load QC data from batch worksheet
    loadQCData();
    
    // Run approval checks
    runApprovalChecks();
});

/**
 * Load saved data from QBench textarea fields
 */
function loadSavedData() {
    try {
        // Load metadata
        const metadataField = document.querySelector('textarea[name="ws_batch_metadata"]');
        if (metadataField && metadataField.value) {
            batchMetadata = JSON.parse(metadataField.value);
            populateMetadataFields();
        }
        
        // Load checklist
        const checklistField = document.querySelector('textarea[name="ws_batch_checklist"]');
        if (checklistField && checklistField.value) {
            checklistData = JSON.parse(checklistField.value);
            populateChecklistFields();
        }
        
        // Load QC results
        const qcField = document.querySelector('textarea[name="ws_batch_qc_results"]');
        if (qcField && qcField.value) {
            qcResults = JSON.parse(qcField.value);
        }
        
        // Load approval data
        const approvalField = document.querySelector('textarea[name="ws_batch_approval"]');
        if (approvalField && approvalField.value) {
            approvalData = JSON.parse(approvalField.value);
            populateApprovalHistory();
        }
        
        console.log('Loaded saved data:', { batchMetadata, checklistData, qcResults, approvalData });
    } catch (error) {
        console.error('Error loading saved data:', error);
    }
}

/**
 * Populate metadata form fields from saved data
 */
function populateMetadataFields() {
    const fields = [
        'instrument-id', 'column-id', 'column-pressure',
        'mobile-phase-lot', 'mobile-phase-prep-date', 'mobile-phase-prep-analyst',
        'run-start-time', 'run-end-time', 'data-reviewed-by',
        'lab-temperature', 'lab-humidity', 'batch-notes'
    ];
    
    fields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        const fieldName = fieldId.replace(/-/g, '_');
        if (element && batchMetadata[fieldName]) {
            element.value = batchMetadata[fieldName];
        }
    });
}

/**
 * Populate checklist checkboxes from saved data
 */
function populateChecklistFields() {
    Object.keys(checklistData).forEach(key => {
        const element = document.getElementById(key);
        if (element) {
            if (element.type === 'checkbox') {
                element.checked = checklistData[key];
            } else {
                element.value = checklistData[key];
            }
        }
    });
}

/**
 * Save batch metadata to QBench field
 */
function saveBatchMetadata() {
    // Collect all metadata fields
    batchMetadata = {
        instrument_id: document.getElementById('instrument-id')?.value || '',
        column_id: document.getElementById('column-id')?.value || '',
        column_pressure_bar: parseFloat(document.getElementById('column-pressure')?.value) || null,
        mobile_phase_lot: document.getElementById('mobile-phase-lot')?.value || '',
        mobile_phase_prep_date: document.getElementById('mobile-phase-prep-date')?.value || '',
        mobile_phase_prep_analyst: document.getElementById('mobile-phase-prep-analyst')?.value || '',
        run_start_time: document.getElementById('run-start-time')?.value || '',
        run_end_time: document.getElementById('run-end-time')?.value || '',
        data_reviewed_by: document.getElementById('data-reviewed-by')?.value || '',
        lab_temperature: parseFloat(document.getElementById('lab-temperature')?.value) || null,
        lab_humidity: parseFloat(document.getElementById('lab-humidity')?.value) || null,
        batch_notes: document.getElementById('batch-notes')?.value || '',
        last_updated: new Date().toISOString()
    };
    
    // Save to hidden textarea
    const metadataField = document.querySelector('textarea[name="ws_batch_metadata"]');
    if (metadataField) {
        metadataField.value = JSON.stringify(batchMetadata);
        console.log('Batch metadata saved:', batchMetadata);
        showNotification('Metadata saved successfully!', 'success');
    }
}

/**
 * Save checklist data to QBench field
 */
function saveChecklist() {
    // Collect all checklist items
    const checkboxes = [
        'check-reagents', 'check-mobile-phase', 'check-standards', 'check-qc-samples',
        'check-column', 'check-calibration', 'check-system-suitability',
        'check-data-uploaded', 'check-qc-reviewed', 'check-samples-reviewed', 'check-deviations-documented'
    ];
    
    const notes = [
        'notes-reagents', 'notes-mobile-phase', 'notes-standards', 'notes-qc-samples',
        'notes-column', 'notes-calibration', 'notes-system-suitability',
        'notes-data-upload', 'notes-qc-review', 'notes-sample-review', 'notes-deviations'
    ];
    
    checkboxes.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            checklistData[id] = element.checked;
        }
    });
    
    notes.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            checklistData[id] = element.value;
        }
    });
    
    checklistData.last_updated = new Date().toISOString();
    
    // Save to hidden textarea
    const checklistField = document.querySelector('textarea[name="ws_batch_checklist"]');
    if (checklistField) {
        checklistField.value = JSON.stringify(checklistData);
        console.log('Checklist saved:', checklistData);
        
        // Re-run approval checks
        runApprovalChecks();
    }
}

/**
 * Load QC data from batch worksheet
 * This would typically come from the control_data field populated by fileParser
 */
function loadQCData() {
    // In a real implementation, this would read from batch.worksheet_json or similar
    // For now, we'll set up the structure to be populated when data is available
    
    console.log('Loading QC data from batch worksheet...');
    
    // Check if control_data exists in batch worksheet
    // This is a placeholder - actual implementation would fetch from QBench
    
    // Example structure:
    // controlData = {
    //     "ccv_1": { qc_type: "CCV", d9_thc_raw: 4.95, cbd_raw: 10.1, ... },
    //     "mb_1": { qc_type: "MB", d9_thc_raw: 0.01, cbd_raw: 0.01, ... },
    //     "matrix_blank_12345": { qc_type: "matrix_blank", sample_id: 123, test_id: 12345, ... },
    //     ...
    // };
    
    // For now, show placeholder
    console.log('QC data will be populated after file upload via fileParser.js');
}

/**
 * Tab switching function
 */
function qbwsSwitchTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.qbws-tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.qbws-tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    const selectedTab = document.getElementById('qbws-' + tabId);
    if (selectedTab) {
        selectedTab.classList.add('active');
    }
    
    // Add active class to clicked button
    event.target.classList.add('active');
}

/**
 * Toggle expandable sections
 */
function qbwsToggleExpandable(element) {
    element.classList.toggle('expanded');
    const content = element.nextElementSibling;
    if (content) {
        content.classList.toggle('show');
    }
}

/**
 * Run pre-approval validation checks
 */
function runApprovalChecks() {
    const checksContainer = document.getElementById('approval-checks-list');
    if (!checksContainer) return;
    
    checksContainer.innerHTML = '';
    
    const checks = [
        {
            name: 'Required checklist items completed',
            test: () => {
                const required = ['check-qc-reviewed', 'check-samples-reviewed'];
                return required.every(id => checklistData[id] === true);
            }
        },
        {
            name: 'Batch metadata complete',
            test: () => {
                const required = ['instrument_id', 'column_id', 'mobile_phase_lot', 'data_reviewed_by'];
                return required.every(field => batchMetadata[field] && batchMetadata[field].trim() !== '');
            }
        },
        {
            name: 'QC data uploaded',
            test: () => {
                return checklistData['check-data-uploaded'] === true;
            }
        }
    ];
    
    let allPass = true;
    
    checks.forEach(check => {
        const passed = check.test();
        if (!passed) allPass = false;
        
        const checkItem = document.createElement('div');
        checkItem.className = `qbws-approval-check-item ${passed ? 'pass' : 'fail'}`;
        checkItem.innerHTML = `
            <span style="font-size: 18px;">${passed ? '✅' : '❌'}</span>
            <span>${check.name}</span>
        `;
        checksContainer.appendChild(checkItem);
    });
    
    // Enable/disable approve button
    const approveBtn = document.getElementById('approve-btn');
    if (approveBtn) {
        approveBtn.disabled = !allPass;
    }
}

/**
 * Approve batch
 */
function approveBatch() {
    const comments = document.getElementById('approval-comments')?.value || '';
    
    if (!confirm('Are you sure you want to approve this batch? This action cannot be undone.')) {
        return;
    }
    
    approvalData = {
        status: 'approved',
        approved_by: batchMetadata.data_reviewed_by || 'Unknown',
        approved_at: new Date().toISOString(),
        comments: comments,
        metadata_snapshot: { ...batchMetadata },
        checklist_snapshot: { ...checklistData }
    };
    
    // Save approval data
    const approvalField = document.querySelector('textarea[name="ws_batch_approval"]');
    if (approvalField) {
        approvalField.value = JSON.stringify(approvalData);
        console.log('Batch approved:', approvalData);
        showNotification('Batch approved successfully!', 'success');
        
        // Update approval history
        populateApprovalHistory();
        
        // Export audit log automatically
        exportAuditLog();
    }
}

/**
 * Reject batch
 */
function rejectBatch() {
    const comments = document.getElementById('approval-comments')?.value || '';
    
    if (!comments.trim()) {
        alert('Please provide a reason for rejection in the comments field.');
        return;
    }
    
    if (!confirm('Are you sure you want to reject this batch?')) {
        return;
    }
    
    approvalData = {
        status: 'rejected',
        rejected_by: batchMetadata.data_reviewed_by || 'Unknown',
        rejected_at: new Date().toISOString(),
        reason: comments,
        metadata_snapshot: { ...batchMetadata },
        checklist_snapshot: { ...checklistData }
    };
    
    // Save approval data
    const approvalField = document.querySelector('textarea[name="ws_batch_approval"]');
    if (approvalField) {
        approvalField.value = JSON.stringify(approvalData);
        console.log('Batch rejected:', approvalData);
        showNotification('Batch rejected. Reason logged.', 'warning');
        
        // Update approval history
        populateApprovalHistory();
    }
}

/**
 * Partial approval (flag samples for retest)
 */
function partialApproval() {
    alert('Partial approval feature coming soon! This will allow you to flag specific samples for retest.');
    // TODO: Implement sample selection UI for retesting
}

/**
 * Populate approval history
 */
function populateApprovalHistory() {
    const historyContainer = document.getElementById('approval-history');
    if (!historyContainer) return;
    
    if (!approvalData || !approvalData.status) {
        historyContainer.innerHTML = '<p style="color: #999;">No approval history available</p>';
        return;
    }
    
    const timestamp = approvalData.approved_at || approvalData.rejected_at || '';
    const actor = approvalData.approved_by || approvalData.rejected_by || 'Unknown';
    const status = approvalData.status.toUpperCase();
    const comments = approvalData.comments || approvalData.reason || 'No comments';
    
    historyContainer.innerHTML = `
        <div style="padding: 15px; background: white; border: 1px solid var(--smithers-gray); border-radius: 4px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span class="qbws-status-badge ${approvalData.status === 'approved' ? 'qbws-status-pass' : 'qbws-status-fail'}">${status}</span>
                <span style="color: #666; font-size: 13px;">${new Date(timestamp).toLocaleString()}</span>
            </div>
            <div style="margin-bottom: 8px;">
                <strong>By:</strong> ${actor}
            </div>
            <div>
                <strong>Comments:</strong> ${comments}
            </div>
        </div>
    `;
}

/**
 * Export audit log as JSON
 */
function exportAuditLog() {
    const auditLog = {
        batch_id: batchConfig.batch_id,
        assay: batchConfig.assay_title,
        assay_id: batchConfig.assay_id,
        export_timestamp: new Date().toISOString(),
        metadata: batchMetadata,
        checklist: checklistData,
        qc_results: qcResults,
        approval: approvalData,
        batch_info: {
            total_samples: batchConfig.total_samples,
            total_tests: batchConfig.total_tests,
            created_at: batchConfig.created_at
        }
    };
    
    // Convert to JSON and download
    const dataStr = JSON.stringify(auditLog, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `batch_${batchConfig.batch_id}_audit_log_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showNotification('Audit log exported successfully!', 'success');
}

/**
 * Show notification toast
 */
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `qbws-alert qbws-alert-${type}`;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '1000';
    notification.style.minWidth = '300px';
    notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s ease';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 500);
    }, 3000);
}
</script>
