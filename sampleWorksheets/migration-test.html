<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QBench Worksheet Migration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-header {
            background: #003a70;
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            text-align: center;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            background: white;
            padding: 20px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .worksheet-panel {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        .worksheet-panel h3 {
            margin: 0 0 15px 0;
            padding: 10px;
            background: #003a70;
            color: white;
            border-radius: 4px;
            text-align: center;
        }
        .test-results {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .test-input {
            margin: 10px 0;
        }
        .test-input label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }
        .test-input input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100px;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .comparison-table th {
            background: #f0f0f0;
            font-weight: bold;
        }
        .result-match {
            background: #d4edda;
            color: #155724;
        }
        .result-mismatch {
            background: #f8d7da;
            color: #721c24;
        }
        .test-controls {
            text-align: center;
            margin: 20px 0;
        }
        .test-controls button {
            background: #236092;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 10px;
            font-weight: bold;
        }
        .test-controls button:hover {
            background: #003a70;
        }
        .status-summary {
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        .iframe-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 400px;
            overflow: auto;
        }
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .test-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>QBench Worksheet Migration Validation</h1>
            <p>Compare calculations between original and modular worksheet implementations</p>
        </div>
        
        <div class="test-controls">
            <button onclick="runTestScenario('basic')">Basic Test</button>
            <button onclick="runTestScenario('moisture')">Moisture Correction Test</button>
            <button onclick="runTestScenario('multiunit')">Multi-Unit Test</button>
            <button onclick="runTestScenario('rsd')">RSD Test</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>
        
        <div class="status-summary" id="test-status">
            <h3>Test Status: Ready</h3>
            <p>Click a test button to begin validation</p>
        </div>
        
        <!-- Test Input Panel -->
        <div class="test-input-panel" style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h3>Test Configuration</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="test-input">
                    <label>THC Value:</label>
                    <input type="number" id="thc-value" value="125.5" step="0.1">
                </div>
                <div class="test-input">
                    <label>CBD Value:</label>
                    <input type="number" id="cbd-value" value="0.8" step="0.1">
                </div>
                <div class="test-input">
                    <label>Sample Weight:</label>
                    <input type="number" id="sample-weight" value="0.5" step="0.01">
                </div>
                <div class="test-input">
                    <label>Extraction Vol:</label>
                    <input type="number" id="extraction-vol" value="100" step="1">
                </div>
                <div class="test-input">
                    <label>Dilution Factor:</label>
                    <input type="number" id="dilution-factor" value="10" step="1">
                </div>
                <div class="test-input">
                    <label>Moisture %:</label>
                    <input type="number" id="moisture-percent" value="12.5" step="0.1">
                </div>
            </div>
        </div>
        
        <!-- Comparison Results -->
        <div class="comparison-grid">
            <div class="worksheet-panel">
                <h3>Original Worksheet</h3>
                <div class="test-results" id="original-results">
                    <h4>Calculation Results</h4>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Analyte</th>
                                <th>Result (ppb)</th>
                                <th>Status</th>
                                <th>RSD %</th>
                            </tr>
                        </thead>
                        <tbody id="original-table-body">
                            <tr><td colspan="4">Run a test to see results</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="test-log" id="original-log">
                    Original worksheet calculation log will appear here...
                </div>
            </div>
            
            <div class="worksheet-panel">
                <h3>Modular Worksheet</h3>
                <div class="test-results" id="modular-results">
                    <h4>Calculation Results</h4>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Analyte</th>
                                <th>Result (ppb)</th>
                                <th>Status</th>
                                <th>RSD %</th>
                            </tr>
                        </thead>
                        <tbody id="modular-table-body">
                            <tr><td colspan="4">Run a test to see results</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="test-log" id="modular-log">
                    Modular worksheet calculation log will appear here...
                </div>
            </div>
        </div>
        
        <!-- Detailed Comparison -->
        <div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h3>Detailed Comparison</h3>
            <table class="comparison-table" id="comparison-details">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Original</th>
                        <th>Modular</th>
                        <th>Match</th>
                        <th>Difference</th>
                    </tr>
                </thead>
                <tbody id="comparison-body">
                    <tr><td colspan="5">Run a test to see detailed comparison</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Mock data for testing calculations
        const testData = {
            analytes: ['thc', 'cbd', 'cbn', 'total_thc'],
            instrumentData: {
                thc: { lod: 0.5, loq: 1.0 },
                cbd: { lod: 0.5, loq: 1.0 },
                cbn: { lod: 0.5, loq: 1.0 }
            },
            limits: {
                thc: 1000,
                cbd: 10000,
                cbn: 500,
                total_thc: 1000
            },
            isomersMap: {
                total_thc: [
                    { analyte: 'thc', factor: 1.0 },
                    { analyte: 'thca', factor: 0.877 }
                ]
            }
        };

        // Original worksheet calculation logic (simplified)
        class OriginalCalculator {
            constructor(config) {
                this.config = config;
                this.wsScaling = {
                    'ppb': 1,
                    'ppm': 1e3,
                    '%': 1e7,
                    'mg/g': 1e6
                };
            }

            convert(value, from, to) {
                if (!(from in this.wsScaling) || !(to in this.wsScaling)) return value;
                if (from === to) return value;
                const ppbValue = value * (this.wsScaling[from] / this.wsScaling['ppb']);
                return ppbValue * (this.wsScaling['ppb'] / this.wsScaling[to]);
            }

            applyMoistureCorrection(value, moisturePercent) {
                if (!moisturePercent || moisturePercent <= 0 || moisturePercent >= 100) {
                    return value;
                }
                return value / (1 - (moisturePercent / 100));
            }

            calculate(analyte, rawValue, testConfig) {
                const { ext, dil, wt, inputUnit, displayUnit, moisturePercent, applyMoisture } = testConfig;
                
                let scaledRaw = this.convert(rawValue, inputUnit, displayUnit) * ext * dil / wt;
                
                if (applyMoisture && moisturePercent > 0) {
                    scaledRaw = this.applyMoistureCorrection(scaledRaw, moisturePercent);
                }
                
                return {
                    result: scaledRaw,
                    formatted: scaledRaw.toFixed(3),
                    status: this.getStatus(scaledRaw, testData.limits[analyte] || 0),
                    unit: displayUnit
                };
            }

            getStatus(value, limit) {
                if (limit <= 0) return "–";
                return value <= limit ? "Pass" : "Fail";
            }
        }

        // Mock modular calculator (would be replaced by CDN modules)
        class ModularCalculator {
            constructor(config) {
                this.config = config;
                // Simulate modular calculation logic
            }

            calculate(analyte, rawValue, testConfig) {
                // Simulate the same calculation as original
                const original = new OriginalCalculator(this.config);
                const result = original.calculate(analyte, rawValue, testConfig);
                
                // Add modular enhancements
                result.enhanced = true;
                result.timestamp = new Date().toISOString();
                
                return result;
            }
        }

        function runTestScenario(scenarioType) {
            updateStatus(`Running ${scenarioType} test scenario...`, 'info');
            
            const testConfig = getTestConfig();
            const originalCalc = new OriginalCalculator({});
            const modularCalc = new ModularCalculator({});
            
            let testValues = {};
            
            switch(scenarioType) {
                case 'basic':
                    testValues = {
                        thc: parseFloat(document.getElementById('thc-value').value) || 125.5,
                        cbd: parseFloat(document.getElementById('cbd-value').value) || 0.8,
                        cbn: 2.3
                    };
                    testConfig.applyMoisture = false;
                    break;
                    
                case 'moisture':
                    testValues = {
                        thc: parseFloat(document.getElementById('thc-value').value) || 125.5,
                        cbd: parseFloat(document.getElementById('cbd-value').value) || 0.8
                    };
                    testConfig.applyMoisture = true;
                    break;
                    
                case 'multiunit':
                    testValues = {
                        thc: 125.5
                    };
                    // Test multiple units
                    break;
                    
                case 'rsd':
                    testValues = {
                        thc: [125.5, 123.2, 127.8, 124.1], // Multiple test values
                        cbd: [0.8, 0.9, 0.7, 0.8]
                    };
                    break;
            }
            
            const originalResults = {};
            const modularResults = {};
            
            // Run calculations
            Object.entries(testValues).forEach(([analyte, value]) => {
                if (Array.isArray(value)) {
                    // Handle RSD scenario
                    const results = value.map(v => originalCalc.calculate(analyte, v, testConfig));
                    originalResults[analyte] = {
                        values: results,
                        mean: results.reduce((sum, r) => sum + r.result, 0) / results.length,
                        rsd: calculateRSD(results.map(r => r.result))
                    };
                    
                    const modResults = value.map(v => modularCalc.calculate(analyte, v, testConfig));
                    modularResults[analyte] = {
                        values: modResults,
                        mean: modResults.reduce((sum, r) => sum + r.result, 0) / modResults.length,
                        rsd: calculateRSD(modResults.map(r => r.result))
                    };
                } else {
                    originalResults[analyte] = originalCalc.calculate(analyte, value, testConfig);
                    modularResults[analyte] = modularCalc.calculate(analyte, value, testConfig);
                }
            });
            
            displayResults(originalResults, modularResults, scenarioType);
            compareResults(originalResults, modularResults);
        }
        
        function getTestConfig() {
            return {
                ext: parseFloat(document.getElementById('extraction-vol').value) || 100,
                dil: parseFloat(document.getElementById('dilution-factor').value) || 10,
                wt: parseFloat(document.getElementById('sample-weight').value) || 0.5,
                inputUnit: 'ppb',
                displayUnit: 'ppb',
                moisturePercent: parseFloat(document.getElementById('moisture-percent').value) || 12.5,
                applyMoisture: false
            };
        }
        
        function calculateRSD(values) {
            if (values.length < 2) return 0;
            const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (values.length - 1);
            const std = Math.sqrt(variance);
            return mean !== 0 ? (std / mean) * 100 : 0;
        }
        
        function displayResults(originalResults, modularResults, scenarioType) {
            const originalBody = document.getElementById('original-table-body');
            const modularBody = document.getElementById('modular-table-body');
            
            originalBody.innerHTML = '';
            modularBody.innerHTML = '';
            
            Object.entries(originalResults).forEach(([analyte, result]) => {
                const origRow = createResultRow(analyte, result);
                const modRow = createResultRow(analyte, modularResults[analyte]);
                
                originalBody.appendChild(origRow);
                modularBody.appendChild(modRow);
            });
            
            logResults('original-log', originalResults);
            logResults('modular-log', modularResults);
        }
        
        function createResultRow(analyte, result) {
            const row = document.createElement('tr');
            
            if (result.values) {
                // RSD scenario
                row.innerHTML = `
                    <td>${analyte.toUpperCase()}</td>
                    <td>${result.mean.toFixed(3)}</td>
                    <td>Pass</td>
                    <td>${result.rsd.toFixed(2)}</td>
                `;
            } else {
                row.innerHTML = `
                    <td>${analyte.toUpperCase()}</td>
                    <td>${result.formatted}</td>
                    <td>${result.status}</td>
                    <td>-</td>
                `;
            }
            
            return row;
        }
        
        function logResults(logId, results) {
            const logElement = document.getElementById(logId);
            const timestamp = new Date().toLocaleTimeString();
            
            let logText = `[${timestamp}] Calculation Results:\n`;
            Object.entries(results).forEach(([analyte, result]) => {
                if (result.values) {
                    logText += `  ${analyte}: mean=${result.mean.toFixed(3)}, rsd=${result.rsd.toFixed(2)}%\n`;
                } else {
                    logText += `  ${analyte}: ${result.formatted} ${result.unit} (${result.status})\n`;
                }
            });
            
            logElement.textContent = logText;
        }
        
        function compareResults(originalResults, modularResults) {
            const comparisonBody = document.getElementById('comparison-body');
            comparisonBody.innerHTML = '';
            
            let allMatch = true;
            const tolerance = 0.001; // Allow small floating point differences
            
            Object.keys(originalResults).forEach(analyte => {
                const orig = originalResults[analyte];
                const mod = modularResults[analyte];
                
                const origValue = orig.values ? orig.mean : orig.result;
                const modValue = mod.values ? mod.mean : mod.result;
                
                const difference = Math.abs(origValue - modValue);
                const matches = difference < tolerance;
                
                if (!matches) allMatch = false;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${analyte.toUpperCase()}</td>
                    <td>${origValue.toFixed(6)}</td>
                    <td>${modValue.toFixed(6)}</td>
                    <td class="${matches ? 'result-match' : 'result-mismatch'}">${matches ? '✓' : '✗'}</td>
                    <td>${difference.toFixed(6)}</td>
                `;
                
                comparisonBody.appendChild(row);
            });
            
            updateStatus(
                allMatch ? 'All calculations match! Migration successful.' : 'Some calculations differ. Review required.',
                allMatch ? 'success' : 'warning'
            );
        }
        
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('test-status');
            const colors = {
                success: '#d4edda',
                warning: '#fff3cd', 
                error: '#f8d7da',
                info: '#d1ecf1'
            };
            
            statusElement.style.background = colors[type] || colors.info;
            statusElement.innerHTML = `
                <h3>Test Status: ${type.charAt(0).toUpperCase() + type.slice(1)}</h3>
                <p>${message}</p>
            `;
        }
        
        function clearResults() {
            document.getElementById('original-table-body').innerHTML = '<tr><td colspan="4">Run a test to see results</td></tr>';
            document.getElementById('modular-table-body').innerHTML = '<tr><td colspan="4">Run a test to see results</td></tr>';
            document.getElementById('comparison-body').innerHTML = '<tr><td colspan="5">Run a test to see detailed comparison</td></tr>';
            document.getElementById('original-log').textContent = 'Original worksheet calculation log will appear here...';
            document.getElementById('modular-log').textContent = 'Modular worksheet calculation log will appear here...';
            updateStatus('Ready for testing', 'info');
        }
        
        // Initialize
        updateStatus('Migration test tool ready. Click a test button to validate calculations.', 'info');
    </script>
</body>
</html>
