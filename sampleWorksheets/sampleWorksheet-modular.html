<!-- QBench Worksheet - Modular Version -->
<!-- This worksheet maintains Jinja templating and site-specific field rendering -->
<!-- while using CDN-hosted modular JavaScript for logic and calculations -->

<style>
/* Smithers Corporate Color Scheme */
:root {
  --smithers-navy-dark: #0a2240;
  --smithers-navy: #003a70;
  --smithers-blue: #236092;
  --smithers-yellow: #f6cd3e;
  --smithers-yellow-light: #fedb54;
  --smithers-gray-dark: #48484a;
  --smithers-gray: #cdcfd0;
  --smithers-gray-light: #e7eaec;
}

/* Container Styling */
.qbench-worksheet-container #ws-tabs {
  margin-bottom: 1rem;
  display: flex;
  flex-wrap: wrap;
  background: var(--smithers-gray-light);
  border-radius: 8px 8px 0 0;
  padding: 5px 5px 0 5px;
}

/* Tab Buttons */
.qbench-worksheet-container .ws-tab-btn {
  float: left; 
  padding: 12px 24px; 
  text-decoration: none;
  margin-right: 2px;
  
  /* Smithers colors */ 
  color: white;
  background: var(--smithers-navy-dark); 
  cursor: pointer;
  font-weight: 500;
  border: none;
  border-radius: 8px 8px 0 0;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.qbench-worksheet-container .ws-tab-btn:hover {
  background: var(--smithers-blue);
  transform: translateY(-1px);
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

.qbench-worksheet-container .ws-tab-btn.active {
  background: var(--smithers-navy);
  font-weight: 700;
  z-index: 3;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* Tab Container */
.qbench-worksheet-container .ws-tab-container {
  background: white;
  border-radius: 0 0 8px 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  padding: 20px;
}

/* Override qbench-core.css button styling to maintain Smithers branding */
.qbench-worksheet-container button {
  background: linear-gradient(135deg, var(--smithers-blue) 0%, var(--smithers-navy) 100%) !important;
  color: white !important;
  border: none !important;
  padding: 10px 20px !important;
  border-radius: 6px !important;
  font-weight: 500 !important;
  cursor: pointer !important;
  transition: all 0.3s ease !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

.qbench-worksheet-container button:hover {
  transform: translateY(-1px) !important;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
}

.qbench-worksheet-container button.btn-primary, 
.qbench-worksheet-container #unlock-data-btn {
  background: linear-gradient(135deg, var(--smithers-yellow) 0%, var(--smithers-yellow-light) 100%) !important;
  color: var(--smithers-navy-dark) !important;
  font-weight: 600 !important;
}

.qbench-worksheet-container button.btn-danger, 
.qbench-worksheet-container #lock-data-btn {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
}

/* Site-specific table styling to maintain Smithers look */
.qbench-worksheet-container .ws-tab-content th {
  background: var(--smithers-gray-light) !important;
  color: var(--smithers-navy-dark) !important;
  font-weight: 600 !important;
  border-bottom: 2px solid var(--smithers-gray) !important;
}

/* Multi-Unit Output Selector - Smithers styling */
.multi-unit-selector-group {
  margin: 15px 0;
  padding: 15px;
  border: 1px solid var(--smithers-gray);
  border-radius: 8px;
  background: #f8f9fa;
}

.multi-unit-selector-group h4 {
  margin: 0 0 10px 0;
  color: var(--smithers-navy-dark);
  font-size: 1rem;
  font-weight: 600;
}

.multi-unit-selector-group input[type="checkbox"] {
  accent-color: var(--smithers-blue);
}

/* Sample Information Section - Smithers styling */
.sample-info-section {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border: 1px solid var(--smithers-gray);
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.sample-info-section h3 {
  margin: 0 0 15px 0;
  color: var(--smithers-navy-dark);
  font-size: 1.3rem;
  font-weight: 600;
  border-bottom: 2px solid var(--smithers-blue);
  padding-bottom: 8px;
}

/* Data Integrity Controls - Smithers styling */
.data-integrity-controls {
  background: var(--smithers-gray-light);
  border: 2px solid var(--smithers-gray);
  border-radius: 8px;
  padding: 15px;
  margin: 15px 0;
}

.data-integrity-controls h4 {
  color: var(--smithers-navy-dark);
  margin-top: 0;
  border-bottom: 2px solid var(--smithers-gray);
  padding-bottom: 8px;
}

/* Legend Section - Smithers styling */
.legend-section {
  background: var(--smithers-gray-light);
  border: 1px solid var(--smithers-gray);
  border-radius: 8px;
  padding: 15px;
  margin: 20px 0;
}

.legend-section h4 {
  color: var(--smithers-navy-dark);
  margin-top: 0;
  border-bottom: 2px solid var(--smithers-gray);
  padding-bottom: 8px;
}
</style>

<!-- Load QBench Core CSS from CDN -->
<link rel="stylesheet" href="https://ashy-pond-044fe2b10.1.azurestaticapps.net/qbench-core.css">

<!-- Load QBench Core JavaScript from CDN -->
<script type="module" src="https://ashy-pond-044fe2b10.1.azurestaticapps.net/qbench-worksheet.js"></script>

<div class="qbench-worksheet-container">

<!-- JSON Config - Maintains Jinja templating for site-specific data injection -->
<script type="application/json" id="ws-unit-config">
  {
    "allowed_units": {{ allowed_units | tojson }},
    "default_units": {{ (kvstore.get('default_units') or ['ppb']) | tojson }},
    "input_unit": "{{ input_unit }}",
    "limit_unit": "{{ limit_unit }}",
    "report_units": "{{ kvstore.get('report_units') or 'ppb' }}",
    "rsd_warning_limit": {{ kvstore.get('rsd_warning_limit') or 15 }},
    "rsd_fail_limit": {{ kvstore.get('rsd_fail_limit') or 25 }},
    "rsd_check_enabled": {{ (kvstore.get('rsd_check_enabled') or 'true') | tojson }},
    "use_moisture_correction": {{ use_moisture_correction | tojson }},
    "moisture_value": {{ ns.moisture_value | tojson }},
    "moisture_found": {{ ns.moisture_found | tojson }},
    "assay_name": "{{ assay_name }}",
    "assay_display_name": "{{ assay_display_name }}",
    "default_compliance": {{ (kvstore.get('default_compliance') if kvstore.get('default_compliance') is not none else true) | tojson }},
    "uncertainty_data": {
      {% for analyte in analytes %}
        "{{ analyte}}_uncertainty": {{ kvstore.get(analyte + '_uncertainty', 0.0)}}{% if not loop.last %},{% endif %}
      {% endfor %}
    }
  }
</script>

<!-- Site-specific data injection using Jinja -->
<script type="application/json" id="ws-instrument-json">{{ instrument_data | tojson }}</script>
<script type="application/json" id="ws-live-json">{{ live_data | tojson }}</script>
<script type="application/json" id="ws-isomers-map">{{ kvstore.get("isomers_map") | tojson }}</script>
<script type="application/json" id="ws-sample-info">
  {
    "sample_id": "{{ tests[0].sample.cc_id if tests[0].sample.cc_id else tests[0].sample.custom_formatted_id }}",
    "sample_name": "{{ tests[0].sample.description if tests[0].sample.description else '' }}",
    "sample_qbn_id": {{ tests[0].sample.id if tests[0].sample.id else 'null' }},
    "serving_weight": {{ tests[0].sample.unit_weight if tests[0].sample.unit_weight else 0 }},
    "servings_per_package": {{ tests[0].sample.units_per_package if tests[0].sample.units_per_package else 0 }}
  }
</script>

<!-- Site-specific configuration for the modular worksheet system -->
<script type="application/json" id="qbench-config">
{
  "worksheetName": "Cannabinoids Analysis",
  "version": "2.0.0",
  "branding": {
    "companyName": "Smithers",
    "colors": {
      "primary": "#003a70",
      "secondary": "#236092",
      "accent": "#f6cd3e"
    }
  },
  "features": {
    "multiUnitOutput": true,
    "moistureCorrection": true,
    "dataIntegrity": true,
    "rsdChecking": true,
    "complianceMode": true,
    "uncertaintyMode": true,
    "confidantCannabis": false,
    "conditionFields": true
  },
  "fieldMappings": {
    "instrumentData": "ws-instrument-json",
    "liveData": "ws-live-json",
    "sampleInfo": "ws-sample-info",
    "unitConfig": "ws-unit-config",
    "isomersMap": "ws-isomers-map"
  },
  "customSelectors": {
    "instrumentInput": ".ws-instrument",
    "finalResult": ".ws-final",
    "status": ".ws-status",
    "includeCheckbox": ".ws-include",
    "tabButton": ".ws-tab-btn",
    "tabContent": ".ws-tab-content"
  },
  "ui": {
    "tabsEnabled": true,
    "summaryTabEnabled": true,
    "statisticsTabEnabled": true,
    "sampleInfoTabEnabled": true,
    "settingsTabEnabled": true
  }
}
</script>

<div id="ws-tabs">
  <button type="button" class="ws-tab-btn active" data-ws-tab="summary">Summary</button>
  {% for t in tests %}
    <button type="button" class="ws-tab-btn" data-ws-tab="{{ t.id }}">Test {{ t.id }}</button>
  {% endfor %}
    <button type="button" class="ws-tab-btn" data-ws-tab="statistics">Statistics</button>
    <button type="button" class="ws-tab-btn" data-ws-tab="sample-info">Sample Info</button>
    <button type="button" class="ws-tab-btn" data-ws-tab="settings">Settings</button>
</div>

<div class="ws-tab-content ws-tab-container" id="ws-tab-summary">
  <h4>Summary Statistics</h4>
  <div id="overall-status-banner" class="overall-status-banner">
    <span id="overall-status-text">Calculating overall status...</span>
    <span id="overall-compliance-badge" class="compliance-badge pending">Pending</span>
  </div>
  <table>
    <thead>
      <tr>
        <th class="summary-sortable">Analyte</th>
        <th class="summary-sortable" name="lod-header">LOD ({{ current_display_unit }})</th>
        <th class="summary-sortable" name="loq-header">LOQ ({{ current_display_unit }})</th>
        <th class="summary-sortable" name="final-header">Result ({{ current_display_unit }})</th>
        <th class="summary-sortable" name="limit-header">Limit</th>
        <th class="summary-sortable">Status</th>
        <th class="summary-sortable">RSD %</th>
      </tr>
    </thead>
    <tbody id="ws-summary-body">
      {% for analyte in analytes %}
        {% set display_name = kvstore.get(analyte ~ '_display_name') %}
        <tr data-ws-analyte="{{ analyte }}">
          <td><strong>{{ display_name or analyte }}</strong></td>
          <td class="ws-lod">-</td>
          <td class="ws-loq">-</td>
          <td class="ws-final">-</td>
          <td class="ws-limit">-</td>
          <td class="ws-status">–</td>
          <td class="ws-rsd">-</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Individual Test Tabs - Maintains Jinja templating for dynamic generation -->
{% for t in tests %}
<div class="ws-tab-content ws-tab-container" id="ws-tab-{{ t.id }}" style="display: none;">
  <h4>Test {{ t.id }} - {{ t.test_type.name }}</h4>
  
  <!-- Test Metadata - Jinja templated -->
  <div class="test-metadata-section">
    <h5>Test Information</h5>
    <div class="test-metadata-grid">
      <div><strong>Sample Weight:</strong> <span id="weight">{{ t.sample_weight_taken | round(4) }}</span> g</div>
      <div><strong>Extraction Volume:</strong> <span id="extraction">{{ t.extraction_volume | round(4) }}</span> mL</div>
      <div><strong>Dilution Factor:</strong> <span id="dilution">{{ t.dilution_factor | round(4) }}</span></div>
      <div><strong>Analyst:</strong> {{ t.analyst_name or "N/A" }}</div>
      <div><strong>Date:</strong> {{ t.date_run.strftime('%m/%d/%Y') if t.date_run else "N/A" }}</div>
      <div><strong>Instrument:</strong> {{ t.instrument.name if t.instrument else "N/A" }}</div>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Include</th>
        <th>Analyte</th>
        <th>Instrument ({{ input_unit }})</th>
        <th name="lod-header">LOD ({{ current_display_unit }})</th>
        <th name="loq-header">LOQ ({{ current_display_unit }})</th>
        <th name="final-header">Result ({{ current_display_unit }})</th>
        <th name="limit-header">Limit</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for analyte in analytes %}
        {% set display_name = kvstore.get(analyte ~ '_display_name') %}
        {% set lod_raw = instrument_data.get(analyte, {}).get('lod', 0) %}
        {% set loq_raw = instrument_data.get(analyte, {}).get('loq', 0) %}
        {% set limit_raw = limits.get(analyte, 0) %}
        
        <tr data-ws-analyte="{{ analyte }}" data-ws-test="{{ t.id }}">
          <td>
            <input type="checkbox" class="ws-include" name="ws_include_{{ analyte }}_{{ t.id }}" checked>
          </td>
          <td><strong>{{ display_name or analyte }}</strong></td>
          <td>
            <input type="number" 
                   class="ws-instrument" 
                   name="ws_instrument_{{ analyte }}_{{ t.id }}" 
                   value="{{ live_data.get(analyte, {}).get(t.id|string, '') }}"
                   step="0.0001" 
                   onchange="QBenchWorksheet.recalculate('{{ t.id }}', '{{ analyte }}')">
          </td>
          <td class="ws-lod" data-ws-raw="{{ lod_raw }}">-</td>
          <td class="ws-loq" data-ws-raw="{{ loq_raw }}">-</td>
          <td class="ws-final" name="ws_final_{{ analyte }}_{{ t.id }}">-</td>
          <td class="ws-limit" data-ws-raw="{{ limit_raw }}">-</td>
          <td class="ws-status">–</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endfor %}

<!-- Statistics Tab -->
<div class="ws-tab-content ws-tab-container" id="ws-tab-statistics" style="display: none;">
  <h4>Statistical Analysis</h4>
  
  <div class="multi-unit-selector-group">
    <h4>Output Units</h4>
    <div class="unit-checkboxes" id="unit-checkboxes">
      <!-- Will be populated by modular JavaScript -->
    </div>
  </div>
  
  <table id="statistics-table">
    <thead>
      <tr>
        <th>Analyte</th>
        <th>Count</th>
        <th name="mean-header">Mean</th>
        <th name="std-header">Std Dev</th>
        <th>RSD %</th>
        <th name="min-header">Min</th>
        <th name="max-header">Max</th>
      </tr>
    </thead>
    <tbody id="ws-statistics-body">
      <!-- Will be populated by modular JavaScript -->
    </tbody>
  </table>
</div>

<!-- Sample Info Tab - Maintains Jinja templating -->
<div class="ws-tab-content ws-tab-container" id="ws-tab-sample-info" style="display: none;">
  <div class="sample-info-section">
    <h3>Sample Information</h3>
    <div class="sample-info-grid">
      <div class="sample-info-card">
        <h4>Basic Information</h4>
        <div class="sample-info-item">
          <span class="sample-info-label">Sample ID:</span>
          <span class="sample-info-value">{{ tests[0].sample.cc_id if tests[0].sample.cc_id else tests[0].sample.custom_formatted_id }}</span>
        </div>
        <div class="sample-info-item">
          <span class="sample-info-label">Sample Name:</span>
          <span class="sample-info-value">{{ tests[0].sample.description if tests[0].sample.description else 'Not specified' }}</span>
        </div>
        <div class="sample-info-item">
          <span class="sample-info-label">QBench ID:</span>
          <span class="sample-info-value">{{ tests[0].sample.id if tests[0].sample.id else 'N/A' }}</span>
        </div>
      </div>
      
      <div class="sample-info-card">
        <h4>Package Information</h4>
        <div class="sample-info-item">
          <span class="sample-info-label">Serving Weight:</span>
          <span class="sample-info-value {% if tests[0].sample.unit_weight %}available{% else %}missing{% endif %}">
            {% if tests[0].sample.unit_weight %}
              {{ tests[0].sample.unit_weight }} g
            {% else %}
              Not available
            {% endif %}
          </span>
        </div>
        <div class="sample-info-item">
          <span class="sample-info-label">Servings per Package:</span>
          <span class="sample-info-value {% if tests[0].sample.units_per_package %}available{% else %}missing{% endif %}">
            {% if tests[0].sample.units_per_package %}
              {{ tests[0].sample.units_per_package }}
            {% else %}
              Not available
            {% endif %}
          </span>
        </div>
        
        {% if not tests[0].sample.unit_weight or not tests[0].sample.units_per_package %}
        <div class="unit-availability-note">
          <strong>Note:</strong> mg/serving and mg/package units require serving weight and servings per package information.
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Settings Tab -->
<div class="ws-tab-content ws-tab-container" id="ws-tab-settings" style="display: none;">
  <h4>Worksheet Settings</h4>
  
  <!-- Data Integrity Controls -->
  <div class="data-integrity-controls">
    <h4>Data Integrity Protection
      <span id="protection-status" class="protection-status unlocked">UNLOCKED</span>
    </h4>
    <button type="button" id="lock-data-btn" class="btn-danger">Lock Data</button>
    <button type="button" id="unlock-data-btn" class="btn-primary" style="display: none;">Unlock Data</button>
    <p>Lock data to prevent accidental modifications during review and final calculations.</p>
  </div>
  
  <!-- Display Settings -->
  <div class="settings-group">
    <h5>Display Settings</h5>
    <label>
      Significant Figures: 
      <input type="number" id="sig-fig-input" min="1" max="6" value="3" onchange="QBenchWorksheet.recalculateAll()">
    </label>
    
    <label>
      Display Unit: 
      <select id="unit-selector" onchange="QBenchWorksheet.changeDisplayUnit()">
        {% for unit in allowed_units %}
          <option value="{{ unit }}" {% if unit == current_display_unit %}selected{% endif %}>{{ unit }}</option>
        {% endfor %}
      </select>
    </label>
  </div>
  
  <!-- Moisture Correction Settings -->
  {% if use_moisture_correction and ns.moisture_found %}
  <div class="moisture-settings-group">
    <h4>Moisture Correction</h4>
    <p><strong>Moisture Content:</strong> <span id="moisture-value">{{ ns.moisture_value | round(2) }}%</span> (from {{ assay_name }})</p>
    
    <label>
      <input type="checkbox" id="moisture-correction-enabled" {% if ns.moisture_value > 0 %}checked{% endif %}>
      Apply moisture correction to calculations
    </label>
    
    <label>
      <input type="checkbox" id="moisture-reporting-enabled" {% if ns.moisture_value > 0 %}checked{% endif %}>
      Apply moisture correction to final reporting
    </label>
    
    <p><em>Moisture correction converts results from "as-tested" to "dry weight" basis.</em></p>
  </div>
  {% endif %}
  
  <!-- RSD Settings -->
  <div class="settings-group">
    <h5>RSD Checking</h5>
    <label>
      <input type="checkbox" id="rsd-check-enabled" {% if kvstore.get('rsd_check_enabled', true) %}checked{% endif %}>
      Enable RSD checking
    </label>
    
    <label>
      RSD Warning Limit (%): 
      <input type="number" id="rsd-warning-limit" min="0" max="100" step="0.1" value="{{ kvstore.get('rsd_warning_limit', 15) }}">
    </label>
    
    <label>
      RSD Fail Limit (%): 
      <input type="number" id="rsd-fail-limit" min="0" max="100" step="0.1" value="{{ kvstore.get('rsd_fail_limit', 25) }}">
    </label>
  </div>
  
  <!-- Compliance Settings -->
  <div class="settings-group">
    <h5>Compliance Mode</h5>
    <label>
      <input type="checkbox" id="compliance-mode-enabled" {% if kvstore.get('default_compliance', true) %}checked{% endif %}>
      Enable compliance checking (show Pass/Fail status)
    </label>
    
    <label>
      <input type="checkbox" id="uncertainty-mode-enabled">
      Enable measurement uncertainty mode
    </label>
  </div>
  
  <!-- Legend Section -->
  <div class="legend-section">
    <h4>Legend</h4>
    <div class="legend-grid">
      <div>
        <strong>Result Types:</strong><br>
        <span class="result-nt">NT</span> Not Tested<br>
        <span class="result-nd">ND</span> Not Detected<br>
        <span class="result-loq">&lt;LOQ</span> Below LOQ
      </div>
      
      <div>
        <strong>Status Types:</strong><br>
        <span class="status-pass">✓ Pass</span> Within limit<br>
        <span class="status-fail">✗ Fail</span> Exceeds limit<br>
        <span class="status-warning">⚠ Warning</span> QC issue
      </div>
      
      <div>
        <strong>RSD Status:</strong><br>
        <span class="rsd-pass">✓ Good</span> ≤ {{ kvstore.get('rsd_warning_limit', 15) }}%<br>
        <span class="rsd-warning">⚠ Warning</span> {{ kvstore.get('rsd_warning_limit', 15) }}-{{ kvstore.get('rsd_fail_limit', 25) }}%<br>
        <span class="rsd-fail">✗ High</span> > {{ kvstore.get('rsd_fail_limit', 25) }}%
      </div>
      
      <div>
        <strong>Special Indicators:</strong><br>
        🌿 Moisture corrected<br>
        ⚡ Critical value (&gt;95% of limit)<br>
        📊 Hover for RSD details
      </div>
    </div>
  </div>
</div>

<!-- Hidden form field to persist live data - maintains QBench integration -->
<input type="hidden" name="ws_live_results" value="{{ live_data | tojson }}">

</div>

<script>
// Site-specific initialization - bridges Jinja data to modular system
document.addEventListener('DOMContentLoaded', function() {
  // Wait for QBench modular system to load
  if (window.QBenchWorksheet) {
    initializeWorksheet();
  } else {
    // If not loaded yet, wait for it
    window.addEventListener('qbench-worksheet-ready', initializeWorksheet);
  }
});

function initializeWorksheet() {
  console.log('Initializing Smithers QBench Worksheet with modular system...');
  
  // Get site-specific configuration from Jinja-templated JSON
  const unitConfig = JSON.parse(document.getElementById('ws-unit-config')?.textContent || '{}');
  const qbenchConfig = JSON.parse(document.getElementById('qbench-config')?.textContent || '{}');
  
  // Initialize the modular worksheet system with site-specific config
  window.QBenchWorksheet.initialize({
    ...qbenchConfig,
    // Merge in unit configuration from KVStore
    unitSettings: unitConfig,
    // Override with any site-specific customizations
    customFunctions: {
      // Site-specific function overrides can go here
      onCalculationComplete: function(analyte, testId, result) {
        // Custom post-calculation logic for Smithers
        console.log(`Smithers: Calculated ${analyte} for test ${testId}: ${result}`);
      },
      
      onStatusChange: function(overallStatus) {
        // Custom status change handling
        console.log(`Smithers: Overall worksheet status changed to: ${overallStatus}`);
      }
    }
  });
  
  // Perform initial calculations
  window.QBenchWorksheet.recalculateAll();
  
  console.log('✓ Smithers QBench Worksheet initialized successfully');
}

// Bridge functions for backward compatibility with existing Jinja templates
function wsRecalculate(testId, analyte) {
  if (window.QBenchWorksheet) {
    window.QBenchWorksheet.recalculate(testId, analyte);
  }
}

function wsRecalculateAll() {
  if (window.QBenchWorksheet) {
    window.QBenchWorksheet.recalculateAll();
  }
}
</script>
